# ============================================================================
# SNAKEMAKE PIPELINE: miRNA Oxidation Analysis
# ============================================================================
# Main orchestrator for the complete analysis pipeline
#
# Usage:
#   snakemake -j 1              # Run all
#   snakemake -j 1 all_step1    # Run only Step 1
#   snakemake -n                # Dry-run (see what would run)
# ============================================================================

# Load configuration
configfile: "config/config.yaml"

# Include step-specific rule files
include: "rules/output_structure.smk"
include: "rules/step1.smk"
include: "rules/step1_5.smk"
include: "rules/step2.smk"
include: "rules/step2_figures.smk"  # Step 2 correct figures (16 figures)
# Step 3 (clustering) runs first after step2 to discover structure
include: "rules/step3.smk"
# Steps 4, 5, 6 can run in parallel after step3 (depend on both step2 and step3)
include: "rules/step4.smk"
include: "rules/step5.smk"
include: "rules/step6.smk"
# Step 7 depends on step6, so it runs after the parallel steps
include: "rules/step7.smk"
# Step 8 (sequence-based analysis) is optional and can run after Step 7
include: "rules/step8.smk"
include: "rules/pipeline_info.smk"
include: "rules/summary.smk"
include: "rules/validation.smk"
include: "rules/viewers.smk"  # HTML viewers for each step

# ============================================================================
# CONFIGURATION VALIDATION (runs first)
# ============================================================================

rule validate_configuration:
    input:
        config_file = "config/config.yaml"
    output:
        validation_report = "results/validation/config_validation.txt"
    params:
        script = "scripts/utils/validate_config.R"
    log:
        "results/validation/config_validation.log"
    shell:
        """
        mkdir -p results/validation
        Rscript {params.script} {input.config_file} > {output} 2>&1 || (cat {output} && exit 1)
        echo "" >> {output}
        echo "Configuration validation completed at $(date)" >> {output}
        """

# ============================================================================
# PACKAGE VALIDATION (runs after config validation)
# ============================================================================

rule validate_packages:
    input:
        rules.validate_configuration.output,
        rules.prepare_validation_dir.output
    output:
        validation_report = "results/validation/package_validation.txt"
    params:
        script = "scripts/utils/validate_package_versions.R"
    log:
        "results/validation/package_validation.log"
    shell:
        """
        mkdir -p results/validation
        Rscript {params.script} > {output} 2>&1 || (cat {output} && exit 1)
        echo "Package validation completed at $(date)" >> {output}
        """

# ============================================================================
# DEFAULT TARGET (when running just 'snakemake')
# ============================================================================

rule all:
    input:
        # Validation (runs first - must pass before pipeline execution)
        rules.validate_configuration.output,
        rules.validate_packages.output,
        # Pipeline execution
        rules.prepare_validation_dir.output,
        rules.create_output_structure.output,
        rules.all_step1.output,
        rules.all_step1_5.output,
        rules.all_step2_figures.output,  # Step 2 correct figures (16 figures: FIG_2.1 to FIG_2.17)
        # Step 3 (clustering) runs first after step2
        rules.all_step3.output,
        # Steps 4, 5, 6 run in parallel after step3
        rules.all_step4.output,
        rules.all_step5.output,
        rules.all_step6.output,
        # Step 7 depends on step6
        rules.all_step7.output,
        # Step 8 (sequence-based analysis) is optional
        # rules.all_step8.output,  # Commented out by default, uncomment to include
        rules.generate_pipeline_info.output,
        rules.generate_summary_report.output,
        rules.validate_pipeline_completion.output


